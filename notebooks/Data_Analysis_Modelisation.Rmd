

```{r}
library(sf)
library(dplyr)
library(spdep)
library(mgcv)
library(ggplot2)
library(tidyr)
library(lubridate)
library(tmap)
```

```{r}

transform_nl_data <- function(NL_data) {
  # Select relevant columns
  relevant_cols <- c(
    grep("^viirs_ntl_annual_v\\d+_avg_masked\\.\\d{4}\\.mean$", names(NL_data), value = TRUE),
    "Level", "gqid", "id", "shapeGroup", "shapeID", "shapeName", "shapeType"
  )
  
  # Subset the dataframe
  df <- NL_data[, relevant_cols]
  
  # Reshape the dataframe
  df_long <- df %>%
    pivot_longer(
      cols = starts_with("viirs"),
      names_to = "year",
      values_to = "VIIRS_NTL"
    ) %>%
    # Extract year from the column name
    mutate(year = as.integer(sub(".*\\.(\\d{4})\\.mean$", "\\1", year))) %>%
    # Rename Level to level for consistency
    rename(level = Level)
  
  # Reorder columns
  df_long <- df_long %>%
    select(VIIRS_NTL, year, level, gqid, id, shapeGroup, shapeID, shapeName, shapeType)
  
  return(df_long)
}

transform_and_aggregate_data <- function(input_df, shapefile_boundari) {
  # Vérifier si le dataframe d'entrée a les colonnes nécessaires
  if (!all(c("shapeName", "VIIRS_NTL", "year") %in% names(input_df))) {
    stop("Le dataframe d'entrée doit avoir les colonnes 'shapeName', 'VIIRS_NTL' et 'year'")
  }
  
  # Vérifier si shapefile_boundari a les colonnes nécessaires
  if (!all(c("ADM4_EN", "ADM3_EN") %in% names(shapefile_boundari))) {
    stop("shapefile_boundari doit avoir les colonnes 'ADM4_EN' et 'ADM3_EN'")
  }
  
  # Joindre les dataframes
  result_df <- input_df %>%
    left_join(shapefile_boundari %>% select(ADM4_EN, ADM3_EN), 
              by = c("shapeName" = "ADM4_EN"))
  
  # Grouper par ADM3_EN et year, puis calculer la moyenne de VIIRS_NTL
  aggregated_df <- result_df %>%
    group_by(ADM3_EN, year) %>%
    summarise(VIIRS_NTL = mean(VIIRS_NTL, na.rm = TRUE)) %>%
    ungroup()
  
  return(aggregated_df)
}

########## Feature engineering functions##########
# Function to normalize data to 0-1 scale
normalize <- function(x) {
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

# Function to apply log scale transformation
log_scale <- function(x) {
  scaled <- (log(x + 1) - log(min(x) + 1)) / (log(max(x) + 1) - log(min(x) + 1))
  scaled * (max(x) - min(x)) + min(x)
}
```

```{r}




#######Load csv & xlsx




flood_and_climate_data <- read.csv("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/data_simplified_with_api_vf.csv")
NL_data <- read.csv("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/66e5ffb23e839964db5b2042/nightlight_info.csv")

NL_data <- transform_nl_data(NL_data)
###### Load shapefile
# transport_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_transport_a_free_1.shp"  # Example path

waterway_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_waterways_free_1.shp"  # Example path

water_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_water_a_free_1.shp"  # Example path

shapefile_path_boundari_adm4 <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bgd_adm_bbs_20201113_SHP/bgd_admbnda_adm4_bbs_20201113.shp"  # Example path
shapefile_path_boundari <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bgd_adm_bbs_20201113_SHP/bgd_admbnda_adm3_bbs_20201113.shp"  # Example path

#### Read the shapefile
# transport <- st_read(transport_shapefile_path)
shapefile_boundari <- st_read(shapefile_path_boundari)
shapefile_boundari_adm4 <- st_read(shapefile_path_boundari_adm4)
shapefile_Dhaka_boundari <- shapefile_boundari[shapefile_boundari$ADM1_EN == "Dhaka", ]
shapefile_Dhaka_boundari_adm4 <- shapefile_boundari_adm4[shapefile_boundari_adm4$ADM1_EN == "Dhaka", ]



NL_data <- transform_and_aggregate_data(NL_data, shapefile_Dhaka_boundari_adm4)

water_Dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_in_dhaka.shp")
water_way_Dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_way_in_dhaka.shp")

shapefile_Dhaka_hazard_exposure <- left_join(shapefile_Dhaka_boundari, hazard_exposure_dhaka, by = "ADM3_EN")

# Merge datasets
climate_spatial_data <- shapefile_Dhaka_boundari %>%
  left_join(flood_and_climate_data, by = "ADM3_EN")

# Convert 'year' to numeric if it's not already
climate_spatial_data$year <- as.numeric(climate_spatial_data$year)

# Merge shafile with NL data
NL_data_spatial <- shapefile_Dhaka_boundari %>%
  left_join(NL_data, by = "ADM3_EN")  

NL_data_spatial$year <- as.numeric(NL_data_spatial$year)

```


```{r}

# Prepare climate data
climate_data <- climate_spatial_data %>%
  select(ADM3_EN, year, river_discharge, precipitation_sum, soil_moisture_0_to_10cm_mean) %>%
  st_drop_geometry()

# Prepare night light data
nl_data <- NL_data_spatial %>%
  select(ADM3_EN, year, VIIRS_NTL) %>%
  st_drop_geometry()

# Merge datasets
combined_data <- climate_data %>%
  left_join(nl_data, by = c("ADM3_EN", "year"))

# Remove any rows with missing values
combined_data <- combined_data %>%
  drop_na()

# Convert ADM3_EN to factor
combined_data$ADM3_EN <- as.factor(combined_data$ADM3_EN)


combined_data_sf <- combined_data %>%
  left_join(shapefile_Dhaka_boundari, by = "ADM3_EN") %>%
  st_as_sf()

```



```{r}

data_2017 <- combined_data_sf %>%
  filter(year == 2017)

ggplot(data_2017) +
  geom_sf(aes(fill = river_discharge), color = NA) +
  scale_fill_viridis_c(name = "River Discharge") +
  theme_minimal() +
  labs(title = "River Discharge in 2017")
```



```{r}

# if (!inherits(data_2017, "sf")) {
#   stop("data_2017 must be an sf object")
# }

# # Create new neighbors list
# nb_2017 <- poly2nb(data_2017, queen = TRUE)

# # Create new weights list
# listw_2017 <- nb2listw(nb_2017, style = "W")

# # Now perform Moran's I test
# moran_test_2017 <- moran.test(data_2017$river_discharge, listw_2017)
# print(moran_test_2017)




# # Create neighbors list
# nb <- poly2nb(shapefile_Dhaka_boundari, queen = TRUE)

# # Create spatial weights list
# listw <- nb2listw(nb, style = "W")

# # Perform Moran's I test for river discharge in 2017
# moran_test_2017 <- moran.test(data_2017$river_discharge, listw)
# print(moran_test_2017)

# data:  data_2017$river_discharge  
# weights: listw_2017

# Moran I statistic standard deviate = 3.7754, p-value = 7.988e-05
# alternative hypothesis: greater
# sample estimates:
# Moran I statistic       Expectation          Variance
#       0.185295570      -0.007874016       0.002617892

```


```{r}
# Your R code here# Create neighbors list
nb <- poly2nb(shapefile_Dhaka_boundari, queen = TRUE)

# Create spatial weights list
listw <- nb2listw(nb, style = "W")

# Perform Moran's I test for river discharge in 2017
moran_test_2017 <- moran.test(data_2017$river_discharge, listw)
print(moran_test_2017)

```



```{r}
# Aggregate river discharge over time

avg_discharge_over_time <- combined_data %>%
  group_by(year) %>%
  summarize(avg_discharge = mean(river_discharge, na.rm = TRUE))

ggplot(avg_discharge_over_time, aes(x = year, y = avg_discharge)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Average River Discharge Over Time",
       x = "Year",
       y = "Average River Discharge")

```


#model Selection

```{r}
# Add coordinates (centroids)
coords <- st_coordinates(st_centroid(combined_data_sf))
combined_data$X <- coords[,1]
combined_data$Y <- coords[,2]

# Ensure 'year' is numeric
combined_data$year <- as.numeric(combined_data$year)

```


#river_discharge as a function of predictors, including spatial and temporal smooths.


```{r}
if (!require(car)) install.packages("car")
library(car)

# Prepare the data for VIF calculation
# We'll use the non-spatial data frame for this
vif_data <- combined_data %>%
  select(river_discharge, precipitation_sum, VIIRS_NTL,soil_moisture_0_to_10cm_mean, year)

# If you have other relevant predictors, include them here

# Fit a linear model with all predictors
lm_model <- lm(river_discharge ~ precipitation_sum + VIIRS_NTL + soil_moisture_0_to_10cm_mean + year, data = vif_data)

# Calculate VIF
vif_results <- vif(lm_model)

# Print VIF results
print(vif_results)

# You can also get a more detailed output
vif_detailed <- data.frame(
  Variable = names(vif_results),
  VIF = vif_results
)
print(vif_detailed)


# > print(vif_detailed)
#                                                  Variable      VIF
# precipitation_sum                       precipitation_sum 1.020045
# VIIRS_NTL                                       VIIRS_NTL 1.029045
# soil_moisture_0_to_10cm_mean soil_moisture_0_to_10cm_mean 1.069112
# year                                                 year 1.078371

```



```{r}
library(mgcv)

# Fit GAM with spatial and temporal smooths
model_gam <- gam(river_discharge ~ s(precipitation_sum) + s(VIIRS_NTL) + s(soil_moisture_0_to_10cm_mean) +
                 te(X, Y, bs = "tp") + s(year, bs = "tp"),
                 data = combined_data,
                 method = "REML")

# Summary of the model
summary(model_gam)

# > summary(model_gam)

# Family: gaussian
# Link function: identity

# Formula:
# river_discharge ~ s(precipitation_sum) + s(VIIRS_NTL) + s(soil_moisture_0_to_10cm_mean) + 
#     te(X, Y, bs = "tp") + s(year, bs = "tp")

# Parametric coefficients:
#             Estimate Std. Error t value Pr(>|t|)
# (Intercept)   1503.5      144.5    10.4   <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Approximate significance of smooth terms:
#                                    edf Ref.df      F p-value
# s(precipitation_sum)             1.025  1.048  0.686 0.41805
# s(VIIRS_NTL)                     3.523  4.436  4.164 0.00195 **
# s(soil_moisture_0_to_10cm_mean)  3.003  3.784 10.825 < 2e-16 ***
# te(X,Y)                         19.420 20.977 23.763 < 2e-16 ***
# s(year)                          3.529  4.364  3.209 0.00962 **
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# R-sq.(adj) =  0.278   Deviance explained = 29.3%
# -REML =  15561  Scale est. = 3.2322e+07  n = 1548

```




```{r}
# Extract residuals
combined_data$residuals_gam <- residuals(model_gam)

# Add residuals to spatial data
combined_data_sf$residuals_gam <- combined_data$residuals_gam

# Moran's I test on residuals for 2017
data_2017 <- combined_data_sf %>%
  filter(year == 2017)

moran_test_resid_2017 <- moran.test(data_2017$residuals_gam, listw)
print(moran_test_resid_2017)

# > print(moran_test_resid_2017)

#         Moran I test under randomisation

# data:  data_2017$residuals_gam
# weights: listw

# Moran I statistic standard deviate = -0.92102, p-value = 0.8215
# alternative hypothesis: greater
# sample estimates:
# Moran I statistic       Expectation          Variance
#      -0.056331409      -0.007812500       0.002775159

```


```{r}

# Check R-squared
cat("Adjusted R-squared:", summary(model_gam)$r.sq, "\n")

# Plot observed vs. predicted river discharge
combined_data$predicted_discharge <- predict(model_gam, newdata = combined_data)

ggplot(combined_data, aes(x = river_discharge, y = predicted_discharge)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, color = 'red') +
  theme_minimal() +
  labs(title = "Observed vs. Predicted River Discharge",
       x = "Observed River Discharge",
       y = "Predicted River Discharge")
```


#Step 5: Model Evaluation
#5.1. Assess Model Fit

```{r}
# Histogram of residuals
ggplot(combined_data, aes(x = residuals_gam)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "white") +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")
```


```{r}


# Predict river discharge using the model
combined_data$predicted_discharge <- predict(model_gam, newdata = combined_data)

# Merge predictions with spatial data
combined_data_sf$predicted_discharge <- combined_data$predicted_discharge

# Map predicted river discharge for 2017
data_2017 <- combined_data_sf %>%
  filter(year == 2017)
ggplot(data_2017) +
  geom_sf(aes(fill = predicted_discharge), color = NA) +
  scale_fill_viridis_c(name = "Predicted River Discharge") +
  theme_minimal() +
  labs(title = "Predicted River Discharge in 2017")

```



#TO GO FURTHER : Add water bodies shapefile for the model 

```{r}

# Assuming 'water_Dhaka' is your water bodies shapefile

# Ensure CRS matches
water_Dhaka <- st_transform(water_Dhaka, st_crs(combined_data_sf))

# Calculate centroids of ADM3_EN regions
adm_centroids <- st_centroid(combined_data_sf)

# Calculate distances
distances <- st_distance(adm_centroids, water_Dhaka)

# Find minimum distance to water body for each region
min_distances <- apply(distances, 1, min)

# Add distances to data
combined_data$distance_to_water <- as.numeric(min_distances)

```


```{r}
# Refit the model including distance to water
model_gam2 <- gam(river_discharge ~ s(precipitation_sum) + s(VIIRS_NTL) +  s(soil_moisture_0_to_10cm_mean) +
                  s(distance_to_water) + te(X, Y, bs = "tp") + s(year, bs = "tp"),
                  data = combined_data,
                  method = "REML")

# Summary of the new model
summary(model_gam2)


# > # Summary of the new model
# > summary(model_gam2)

# Family: gaussian
# Link function: identity

# Formula:
# river_discharge ~ s(precipitation_sum) + s(VIIRS_NTL) + s(soil_moisture_0_to_10cm_mean) + 
#     s(distance_to_water) + te(X, Y, bs = "tp") + s(year, bs = "tp")

# Parametric coefficients:
#             Estimate Std. Error t value Pr(>|t|)
# (Intercept)   1503.5      139.4   10.79   <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Approximate significance of smooth terms:
#                                    edf Ref.df      F  p-value
# s(precipitation_sum)             1.008  1.016  0.900   0.3448
# s(VIIRS_NTL)                     2.790  3.556  2.730   0.0330 *
# s(soil_moisture_0_to_10cm_mean)  3.338  4.195  8.821 1.01e-06 ***
# s(distance_to_water)             5.473  6.576 17.091  < 2e-16 ***
# te(X,Y)                         19.407 20.934 24.553  < 2e-16 ***
# s(year)                          3.364  4.164  2.854   0.0202 *
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# R-sq.(adj) =  0.328   Deviance explained = 34.4%
# -REML =  15505  Scale est. = 3.0085e+07  n = 1548


```


```{r}
# library(spatialreg)

# # Fit spatial lag model
# model_slag <- lagsarlm(river_discharge ~ precipitation_sum + VIIRS_NTL + distance_to_water + year,
#                        data = combined_data_sf, listw = listw)

# # Summary of the model
# summary(model_slag)

```