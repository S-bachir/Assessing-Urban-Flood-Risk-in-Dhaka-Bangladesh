

```{r}

#------------------------------------------------------------------------------#
#Packages/library importation
#------------------------------------------------------------------------------#

library(data.table)
library(dplyr)
library(gganimate)
library(ggcorrplot)
library(ggimage)
library(ggnewscale)
library(ggplot2)
library(ggspatial)
library(ggtext)
library(ggthemes)
library(grid)
library(gridExtra)
library(lubridate)
library(magick)
library(patchwork) # For arranging multiple plots
library(png)
library(readxl)
library(rmapshaper)
library(scales)
library(sf)
library(tidyr)
library(viridis)


```


```{r}
#------------------------------------------------------------------------------#
#Utils functions
#------------------------------------------------------------------------------#
################## Data transformation functions##################

transform_nl_data <- function(NL_data) {
  # Select relevant columns
  relevant_cols <- c(
    grep("^viirs_ntl_annual_v\\d+_avg_masked\\.\\d{4}\\.mean$", names(NL_data), value = TRUE),
    "Level", "gqid", "id", "shapeGroup", "shapeID", "shapeName", "shapeType"
  )
  
  # Subset the dataframe
  df <- NL_data[, relevant_cols]
  
  # Reshape the dataframe
  df_long <- df %>%
    pivot_longer(
      cols = starts_with("viirs"),
      names_to = "year",
      values_to = "VIIRS_NTL"
    ) %>%
    # Extract year from the column name
    mutate(year = as.integer(sub(".*\\.(\\d{4})\\.mean$", "\\1", year))) %>%
    # Rename Level to level for consistency
    rename(level = Level)
  
  # Reorder columns
  df_long <- df_long %>%
    select(VIIRS_NTL, year, level, gqid, id, shapeGroup, shapeID, shapeName, shapeType)
  
  return(df_long)
}


transform_and_aggregate_data <- function(input_df, shapefile_boundari) {
  # Vérifier si le dataframe d'entrée a les colonnes nécessaires
  if (!all(c("shapeName", "VIIRS_NTL", "year") %in% names(input_df))) {
    stop("Le dataframe d'entrée doit avoir les colonnes 'shapeName', 'VIIRS_NTL' et 'year'")
  }
  
  # Vérifier si shapefile_boundari a les colonnes nécessaires
  if (!all(c("ADM4_EN", "ADM3_EN") %in% names(shapefile_boundari))) {
    stop("shapefile_boundari doit avoir les colonnes 'ADM4_EN' et 'ADM3_EN'")
  }
  
  # Joindre les dataframes
  result_df <- input_df %>%
    left_join(shapefile_boundari %>% select(ADM4_EN, ADM3_EN), 
              by = c("shapeName" = "ADM4_EN"))
  
  # Grouper par ADM3_EN et year, puis calculer la moyenne de VIIRS_NTL
  aggregated_df <- result_df %>%
    group_by(ADM3_EN, year) %>%
    summarise(VIIRS_NTL = mean(VIIRS_NTL, na.rm = TRUE)) %>%
    ungroup()
  
  return(aggregated_df)
}

########## Feature engineering functions##########
# Function to normalize data to 0-1 scale
normalize <- function(x) {
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

# Function to apply log scale transformation
log_scale <- function(x) {
  scaled <- (log(x + 1) - log(min(x) + 1)) / (log(max(x) + 1) - log(min(x) + 1))
  scaled * (max(x) - min(x)) + min(x)
}


```

```{r}
#------------------------------------------------------------------------------#
#Data importation
#------------------------------------------------------------------------------#

# Flood_2016_shapefile <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/eo4sd_dhaka_flood_2016/EO4SD_DHAKA_FLOOD_2016.shp")
# flood_2014_shapefile <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/eo4sd_dhaka_flood_2014/EO4SD_DHAKA_FLOOD_2014.shp")

# Flood_2016_shapefile <- st_transform(Flood_2016_shapefile, st_crs(shapefile_Dhaka_boundari))
# flood_2014_shapefile <- st_transform(flood_2014_shapefile, st_crs(shapefile_Dhaka_boundari))

# # Verify that all shapefiles now have the same CRS
# st_crs(Flood_2016_shapefile) == st_crs(shapefile_Dhaka_boundari)
# st_crs(flood_2014_shapefile) == st_crs(shapefile_Dhaka_boundari)

# # Intersect flood shapefiles with Dhaka boundary
# flood_2014_dhaka <- st_intersection(flood_2014_shapefile, shapefile_Dhaka_boundari)
# flood_2016_dhaka <- st_intersection(Flood_2016_shapefile, shapefile_Dhaka_boundari)

# # Add year column
# flood_2014_dhaka$year <- 2014
# flood_2016_dhaka$year <- 2016

# st_write(flood_2014_dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/flood_2014_in_dhaka.shp")
# st_write(flood_2016_dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/flood_2016_in_dhaka.shp")
flood_2014_dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/flood_2014_in_dhaka.shp")
flood_2016_dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/flood_2016_in_dhaka.shp")



# Combine the datasets
combined_flood_data <- rbind(flood_2014_dhaka, flood_2016_dhaka)

####### Load csv & xlsx
file_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/INFORM_Sub-national Risk Index for Bangladesh_ 2022_Admin Level 3_V1.xlsx"

### Read the "INFORM Upazila" sheet
inform_upazila <- read_excel(file_path, sheet = "INFORM Upazila")
inform_upazila <- inform_upazila[-c(1:3), ]
### Read the "Hazard & Exposure" sheet
hazard_exposure <- read_excel(file_path, sheet = "Hazard & Exposure")
hazard_exposure <- hazard_exposure[-c(1:3), ]
# Filter hazard_exposure for Dhaka division
hazard_exposure_dhaka <- hazard_exposure[hazard_exposure$`ADMIN LEVEL-1\r\n(Division)` == "Dhaka", ]
# Rename columns for easier handling
names(hazard_exposure_dhaka)[names(hazard_exposure_dhaka) == "ADMIN LEVEL -3 \r\n(Upazila)"] <- "ADM3_EN"
names(hazard_exposure_dhaka)[names(hazard_exposure_dhaka) == "Flood Risk ( Riverine and Flash Flood)"] <- "flood_risk"


flood_and_climate_data <- read.csv("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/data_simplified_with_api_vf.csv")
flood_and_climate_data_month <- read.csv("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/data_with_api_V2.csv")
NL_data <- read.csv("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/66e5ffb23e839964db5b2042/nightlight_info.csv")






NL_data <- transform_nl_data(NL_data)
###### Load shapefile
# transport_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_transport_a_free_1.shp"  # Example path

waterway_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_waterways_free_1.shp"  # Example path

water_shapefile_path <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bangladesh-latest-free.shp/gis_osm_water_a_free_1.shp"  # Example path

shapefile_path_boundari_adm4 <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bgd_adm_bbs_20201113_SHP/bgd_admbnda_adm4_bbs_20201113.shp"  # Example path
shapefile_path_boundari <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Raw/bgd_adm_bbs_20201113_SHP/bgd_admbnda_adm3_bbs_20201113.shp"  # Example path

#### Read the shapefile
# transport <- st_read(transport_shapefile_path)
shapefile_boundari <- st_read(shapefile_path_boundari)
shapefile_boundari_adm4 <- st_read(shapefile_path_boundari_adm4)
shapefile_Dhaka_boundari <- shapefile_boundari[shapefile_boundari$ADM1_EN == "Dhaka", ]
shapefile_Dhaka_boundari_adm4 <- shapefile_boundari_adm4[shapefile_boundari_adm4$ADM1_EN == "Dhaka", ]



NL_data <- transform_and_aggregate_data(NL_data, shapefile_Dhaka_boundari_adm4)
# Définir la zone d'intérêt (boundary)
# boundary <- shapefile_Dhaka_boundari

# # Convertir la zone d'intérêt en WKT (Well-Known Text)
# boundary_wkt <- st_as_text(st_union(boundary))

# water_Dhaka <- st_read(water_shapefile_path, wkt_filter = boundary_wkt)
# water_way_Dhaka <- st_read(waterway_shapefile_path, wkt_filter = boundary_wkt)

# st_write(water_way_Dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_way_in_dhaka.shp")
# st_write(water_Dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_in_dhaka.shp")
water_Dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_in_dhaka.shp")
water_way_Dhaka <- st_read("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_way_in_dhaka.shp")

#water_way <- st_read(waterway_shapefile_path)
#water <- st_read(water_shapefile_path)

# Ensure all shapefiles are in the same CRS
# transport <- st_transform(transport, st_crs(shapefile_Dhaka_boundari))
#water_way <- st_transform(water_way, st_crs(shapefile_Dhaka_boundari))
#water <- st_transform(water, st_crs(shapefile_Dhaka_boundari))
#Clip to Dhaka region
# transport_Dhaka <- st_intersection(transport, shapefile_Dhaka_boundari)

# Function to process and save/load shapefiles
#output_dir <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/"



#Optional

# st_write(transport_Dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/transport_in_dhaka.shp")
# st_write(water_way_Dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_way_in_dhaka.shp")
# st_write(water_Dhaka, "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/data/Processed/water_in_dhaka.shp")
# Join the hazard_exposure data with the Dhaka shapefile based on ADM3_EN
shapefile_Dhaka_hazard_exposure <- left_join(shapefile_Dhaka_boundari, hazard_exposure_dhaka, by = "ADM3_EN")

# Merge datasets
climate_spatial_data <- shapefile_Dhaka_boundari %>%
  left_join(flood_and_climate_data, by = "ADM3_EN")

# Convert 'year' to numeric if it's not already
climate_spatial_data$year <- as.numeric(climate_spatial_data$year)

# Merge shafile with NL data
NL_data_spatial <- shapefile_Dhaka_boundari %>%
  left_join(NL_data, by = "ADM3_EN")  

NL_data_spatial$year <- as.numeric(NL_data_spatial$year)

# ggplot() +
#   # Flood risk layer
#   geom_sf(data = shapefile_Dhaka_hazard_exposure, aes(fill = flood_risk),
#           color = "white", linewidth = 0.1) +
#   scale_fill_viridis_c(option = "plasma", name = "Flood Risk", 
#                        direction = -1, alpha = 0.7, 
#                        guide = guide_colorbar(order = 1)) +
  
#   # New fill scale for water bodies
#   new_scale_fill() +
  
#   # Water bodies layer
#   geom_sf(data = water_Dhaka, aes(fill = fclass), color = NA, alpha = 0.6) +
#   scale_fill_manual(values = c("wetland" = "#8FBC8F", 
#                                "water" = "#87CEFA",
#                                "reservoir" = "#4682B4",
#                                "dock" = "#20B2AA",
#                                "riverbank" = "#98FB98"),
#                     name = "Water Bodies",
#                     guide = guide_legend(order = 2)) +
  
#   # Waterways layer
#   geom_sf(data = water_way_Dhaka, aes(color = fclass), linewidth = 0.7) +
#   scale_color_manual(values = c("river" = "#0077BE", 
#                                 "canal" = "#40E0D0", 
#                                 "stream" = "#48D1CC",
#                                 "drain" = "#5F9EA0"),
#                      name = "Waterways",
#                      guide = guide_legend(order = 3)) +
  
#   # Rest of your code (annotations, labels, theme, etc.)
#   annotation_scale(location = "bl", width_hint = 0.3) +
#   annotation_north_arrow(location = "tr", which_north = "true", 
#                          pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
#                          style = north_arrow_fancy_orienteering) +
#   labs(title = "Flood Risk and Water Features in Dhaka, Bangladesh (2022)",
#        subtitle = "Visualizing flood vulnerability, water bodies, and hydrological networks",
#        caption = "Source: INFORM Sub-national Risk Index & OpenStreetMap 2022 | Created by: Bachir Sabo") +
#   theme_minimal() +
#   theme(
#     plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
#     plot.subtitle = element_text(size = 14, hjust = 0.5, margin = margin(b = 20)),
#     plot.caption = element_text(size = 10, hjust = 1, margin = margin(t = 20)),
#     legend.position = "right",
#     legend.box = "vertical",
#     legend.margin = margin(t = 10, b = 10, l = 10, r = 10),
#     panel.grid.major = element_line(color = "gray90", linewidth = 0.2),
#     panel.grid.minor = element_blank(),
#     plot.background = element_rect(fill = "white", color = NA),
#     panel.background = element_rect(fill = "white", color = NA)
#   ) +
#   coord_sf(datum = NA)

# Plot the shapefile with enhancements
# ggplot() +
#   geom_sf(data = shapefile_Dhaka_boundari[shapefile_Dhaka_boundari$ADM1_EN == "Dhaka", ],
#           fill = "lightblue", color = "black", size = 0.5, alpha = 0.7) +
#   geom_sf(data = transport_Dhaka, color = "red", size = 0.3, alpha = 0.8) +
#   labs(title = "Transportation Network in Dhaka, Bangladesh",
#        subtitle = "Highlighting major roads and transportation infrastructure",
#        caption = "Data Source: OpenStreetMap | Created by: Bachir S") +
#   theme_minimal() +
#   theme(
#     plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
#     plot.subtitle = element_text(size = 14, hjust = 0.5),
#     plot.caption = element_text(size = 10, hjust = 1),
#     legend.position = "none",
#     panel.grid.major = element_line(color = "gray90", size = 0.2),
#     panel.grid.minor = element_blank(),
#     axis.text = element_blank(),
#     axis.title = element_blank(),
#     panel.border = element_blank()
#   ) +
#   coord_sf(datum = NA)

```




#LINEPLOTS

```{r}

if (!dir.exists("reports/plots")) {
  dir.create("reports/plots", recursive = TRUE)
}

#------------------------------------------------------------------------------#
# 1. Monthly River Discharge Trend (2012-2022)
#------------------------------------------------------------------------------#

# Convert date_my to Date type and create a monthly average
monthly_avg_discharge <- flood_and_climate_data_month %>%
  mutate(date = ymd(date_my)) %>%
  filter(date >= ymd("2010-01-01") & date <= ymd("2024-07-31")) %>%
  group_by(date = floor_date(date, "month")) %>%
  summarise(avg_discharge = mean(river_discharge, na.rm = TRUE))

# Create the line plot
discharge_trend_plot <- ggplot(monthly_avg_discharge, aes(x = date, y = avg_discharge)) +
  geom_line(color = "blue", size = 0.5) +
  geom_smooth(method = "loess", color = "red", se = FALSE, size = 1) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  ) +
  labs(
    title = "Monthly Average River Discharge Trend in Dhaka (2010-2024)",
    subtitle = "Based on CEMS GloFAS Historical Dataset",
    x = "Date",
    y = "Average River Discharge (m³/s)",
    caption = "Data Source: CEMS-GloFAS historical dataset | Visualization: Bachir Sabo"
  ) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = scales::comma)

# Save the plot
ggsave("reports/plots/dhaka_monthly_river_discharge_trend_2010_2024.png", discharge_trend_plot, width = 15, height = 8, dpi = 300)

#------------------------------------------------------------------------------#
# 2. Yearly Mean River Discharge (Bar Plot)
#------------------------------------------------------------------------------#

# Calculate mean river discharge per year
yearly_discharge_mean <- flood_and_climate_data_month %>%
  group_by(year) %>%
  summarise(mean_discharge = mean(river_discharge, na.rm = TRUE))

# Create the bar plot
discharge_mean_plot <- ggplot(yearly_discharge_mean, aes(x = factor(year), y = mean_discharge)) +
  geom_bar(stat = "identity", fill = "steelblue", color = "black") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  labs(
    title = "Mean River Discharge per Year in Dhaka",
    subtitle = "Average of Monthly River Discharge",
    x = "Year",
    y = "Mean River Discharge (m³/s)",
    caption = "Data Source: CEMS-GloFAS historical dataset | Visualization: Bachir Sabo"
  ) +
  scale_y_continuous(labels = scales::comma)

# Save the plot
ggsave("reports/plots/dhaka_mean_river_discharge_per_year.png", discharge_mean_plot, width = 12, height = 8, dpi = 300)

#------------------------------------------------------------------------------#
# 3. Normalized Trends: River Discharge, Precipitation, and Night Light Intensity
#------------------------------------------------------------------------------#

# Calculate yearly averages and normalize
yearly_avg_data <- flood_and_climate_data %>%
  filter(year >= 2010 & year <= 2024) %>%
  group_by(year) %>%
  summarise(
    avg_discharge = mean(river_discharge, na.rm = TRUE),
    avg_precipitation = mean(precipitation_sum, na.rm = TRUE)
  ) %>%
  mutate(
    norm_discharge = normalize(avg_discharge),
    norm_precipitation = normalize(avg_precipitation)
  )

# Calculate yearly averages for night light data and normalize
yearly_avg_nightlight <- NL_data %>%
  filter(year >= 2010 & year <= 2024) %>%
  group_by(year) %>%
  summarise(avg_nightlight = mean(VIIRS_NTL, na.rm = TRUE)) %>%
  mutate(norm_nightlight = normalize(avg_nightlight))

# Merge the two datasets
yearly_avg_data <- left_join(yearly_avg_data, yearly_avg_nightlight, by = "year")

# Create the plot with normalized data
normalized_trend_plot <- ggplot(yearly_avg_data, aes(x = year)) +
  geom_line(aes(y = norm_discharge, color = "River Discharge"), size = 1) +
  geom_point(aes(y = norm_discharge, color = "River Discharge"), size = 3) +
  geom_line(aes(y = norm_precipitation, color = "Precipitation"), size = 1) +
  geom_point(aes(y = norm_precipitation, color = "Precipitation"), size = 3) +
  geom_line(aes(y = norm_nightlight, color = "Night Light"), size = 1) +
  geom_point(aes(y = norm_nightlight, color = "Night Light"), size = 3) +
  scale_y_continuous(
    name = "Normalized Value",
    labels = scales::number_format(accuracy = 0.01),
    limits = c(0, 1)
  ) +
  scale_x_continuous(breaks = 2010:2024) +
  scale_color_manual(values = c("River Discharge" = "blue", "Precipitation" = "darkgreen", "Night Light" = "orange")) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "bottom",
    legend.title = element_blank()
  ) +
  labs(
    title = "Normalized Trends in Dhaka (2010-2024)",
    subtitle = "River Discharge, Precipitation, and Night Light Intensity",
    x = "Year",
    y = "Normalized Value (0-1 scale)",
    caption = "Data Sources: CEMS-GloFAS historical dataset & VIIRS Nighttime Lights | Visualization: Bachir Sabo"
  )

# Save the plot
ggsave("reports/plots/dhaka_normalized_trends_2010_2024.png", normalized_trend_plot, width = 15, height = 10, dpi = 300)

#------------------------------------------------------------------------------#
# 4. Flood Extent Comparison (2014 vs 2016)
#------------------------------------------------------------------------------#

# Create the plot
flood_comparison_plot <- ggplot() +
  geom_sf(data = shapefile_Dhaka_boundari, fill = NA, color = "black", size = 0.5) +
  geom_sf(data = combined_flood_data, aes(fill = WATERTYPE), color = NA, alpha = 0.7) +
  scale_fill_manual(values = c("Flooded" = "blue", "Non-flooded" = "lightgreen"),
                    name = "Water Type") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    legend.position = "bottom",
    legend.key.size = unit(1, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 14, face = "bold")
  ) +
  labs(
    title = "Flood Extent in Dhaka",
    subtitle = "Comparison between 2014 and 2016",
    caption = "Data Source: World Bank (EO4SD Dhaka Flood) | Visualization: Bachir Sabo"
  ) +
  facet_wrap(~year, ncol = 2) +
  coord_sf()

# Save the plot
ggsave("reports/plots/dhaka_flood_comparison_2014_2016.png", flood_comparison_plot, width = 15, height = 10, dpi = 300)


#------------------------------------------------------------------------------#
# 5. Create the plot with normalized data and flood event + icones for flood categories
#------------------------------------------------------------------------------#

# Create the plot with normalized data and flood event images
normalized_trend_plot <- ggplot(yearly_avg_data, aes(x = year)) +
  geom_line(aes(y = norm_discharge, color = "River Discharge"), size = 1) +
  geom_point(aes(y = norm_discharge, color = "River Discharge"), size = 3) +
  geom_line(aes(y = norm_precipitation, color = "Precipitation"), size = 1) +
  geom_point(aes(y = norm_precipitation, color = "Precipitation"), size = 3) +
  geom_line(aes(y = norm_nightlight, color = "Night Light"), size = 1) +
  geom_point(aes(y = norm_nightlight, color = "Night Light"), size = 3) +
  geom_image(data = flood_events, aes(x = year, y = 1.05, image = image, group = category), size = 0.05, asp = 1.5) +
  scale_y_continuous(
    name = "Normalized Value",
    labels = scales::number_format(accuracy = 0.01),
    limits = c(0, 1.1)
  ) +
  scale_x_continuous(breaks = 2010:2024) +
  scale_color_manual(values = c("River Discharge" = "blue", "Precipitation" = "darkgreen", "Night Light" = "orange")) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "bottom",
    legend.box = "vertical",
    legend.margin = margin(t = 10, b = 10)
  ) +
  labs(
    title = "Normalized Trends in Dhaka (2010-2024) with Flood Events",
    subtitle = "River Discharge, Precipitation, Night Light Intensity, and Flood Occurrences",
    x = "Year",
    y = "Normalized Value (0-1 scale)",
    caption = "Data Sources: CEMS-GloFAS historical dataset & VIIRS Nighttime Lights | Visualization: Bachir Sabo"
  ) +
  guides(
    color = guide_legend(order = 1, title = "Trends"),
    group = guide_legend(order = 2, title = "Flood Category",
                         override.aes = list(
                           shape = 21,
                           fill = c("yellow", "orange", "red"),
                           color = "black",
                           size = 5
                         ))
  )

# Create a separate legend for flood categories with images
flood_legend <- ggplot(flood_events, aes(x = 1, y = 1, image = image)) +
  geom_image(size = 0.2) +
  facet_wrap(~category, ncol = 3, labeller = labeller(category = c("1" = "Category 1", "2" = "Category 2", "3" = "Category 3"))) +
  theme_void() +
  theme(strip.text = element_text(size = 10))

# Combine the main plot and the flood legend
final_plot <- grid.arrange(normalized_trend_plot, flood_legend, 
                           ncol = 1, heights = c(0.9, 0.1))

# Save the plot
ggsave("reports/plots/dhaka_normalized_trends_with_floods_2010_2024_img_legend.png", final_plot, width = 15, height = 12, dpi = 300)

```


#MAPS plots

```{r}

# Ensure the required data is loaded:
# shapefile_Dhaka_hazard_exposure, shapefile_Dhaka_boundari,
# combined_flood_data, NL_data_spatial, water_Dhaka, water_way_Dhaka

#------------------------------------------------------------------------------#
# Define a custom theme for all maps
#------------------------------------------------------------------------------#
map_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    legend.spacing.y = unit(0.5, "cm"),
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.caption = element_text(size = 12, hjust = 1, margin = margin(t = 10))
  )
#------------------------------------------------------------------------------#
# 1. Flood Risk Map (2022)
#------------------------------------------------------------------------------#
# This map visualizes the flood risk levels in Dhaka for the year 2022 using data
# from the INFORM Sub-national Risk Index. Areas are colored based on their flood
# risk score, highlighting regions that are more vulnerable to flooding.

flood_risk_map <- ggplot() +
  geom_sf(data = shapefile_Dhaka_hazard_exposure, aes(fill = flood_risk), color = NA) +
  scale_fill_gradientn(
    colors = c("#FFFFD9", "#FED98E", "#FE9929", "#D95F0E", "#993404"),
    breaks = c(0.0, 2.5, 5.0, 7.5),
    labels = c("0.0", "2.5", "5.0", "7.5"),
    name = "Flood Risk"
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "1. Flood Risk Map of Dhaka (2022)",
    caption = "Source: INFORM Sub-national Risk Index & OpenStreetMap 2022 | Visualization: Bachir Sabo"
  ) +
  coord_sf(datum = NA)

#------------------------------------------------------------------------------#
# 2. Night Light Intensity Map (2022)
#------------------------------------------------------------------------------#
# This map shows the night light intensity in Dhaka for the year 2022 using data
# from the VIIRS Nighttime Lights. Higher values indicate brighter areas, which
# can be correlated with urban development and economic activity.

NL_data_2022 <- NL_data_spatial %>% filter(year == 2022)

night_light_intensity_map <- ggplot() +
  geom_sf(data = NL_data_2022, aes(fill = VIIRS_NTL), color = NA) +
  scale_fill_viridis_c(
    option = "inferno",
    name = "Night Light Intensity",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = 10,
      barheight = 0.5
    )
  ) +
  annotation_scale(location = "bl", width_hint = 0.3, color = "black") +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering(fill = "black", line_col = "black")
  ) +
  map_theme +
  labs(
    title = "2. Night Light Intensity Map of Dhaka (2022)",
    caption = "Source: VIIRS Nighttime Lights | Visualization: Bachir Sabo"
  ) +
  coord_sf(datum = NA)

#------------------------------------------------------------------------------#
# 3. Flood Extent Comparison Map (2014 vs 2016)
#------------------------------------------------------------------------------#
# This map compares the flood extent in Dhaka between the years 2014 and 2016.
# It highlights areas that were flooded and non-flooded during these years,
# providing insight into how flood patterns have changed over time.

flood_extent_comparison_map <- ggplot() +
  geom_sf(data = shapefile_Dhaka_boundari, fill = NA, color = "black", size = 0.5) +
  geom_sf(data = combined_flood_data, aes(fill = WATERTYPE), color = NA, alpha = 0.7) +
  scale_fill_manual(
    values = c("Flooded" = "blue", "Non-flooded" = "lightgreen"),
    name = "Water Type"
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "3. Flood Extent Comparison in Dhaka (2014 vs 2016)",
    subtitle = "Comparison of flooded areas between 2014 and 2016",
    caption = "Source: World Bank (EO4SD Dhaka Flood) | Visualization: Bachir Sabo"
  ) +
  facet_wrap(~year, ncol = 2) +
  coord_sf()

#------------------------------------------------------------------------------#
# 4. Water Bodies and Waterways Map
#------------------------------------------------------------------------------#
# This map displays the water bodies and waterways in Dhaka, including rivers,
# canals, streams, and drains. It provides a visual representation of the
# hydrological features that can influence flood risk in the area.

water_bodies_and_waterways_map <- ggplot() +
  geom_sf(data = water_Dhaka, aes(fill = fclass), color = NA, alpha = 0.8) +
  scale_fill_manual(
    values = c(
      "water" = "#87CEFA",
      "dock" = "#20B2AA",
      "wetland" = "#300101",
      "riverbank" = "grey",
      "Other" = "#B0E0E6"
    ),
    name = "Water Bodies"
  ) +
  geom_sf(
    data = filter(water_way_Dhaka, fclass %in% c("river", "canal", "stream", "drain")),
    aes(color = fclass), linewidth = 0.7
  ) +
  scale_color_manual(
    values = c(
      "river" = "#1E90FF",
      "canal" = "#00CED1",
      "stream" = "#20B2AA",
      "drain" = "red"
    ),
    name = "Waterways"
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "4. Water Bodies and Waterways in Dhaka",
    caption = "Source: OpenStreetMap | Visualization: Bachir Sabo"
  ) +
  coord_sf(datum = NA) +
  guides(
    fill = guide_legend(title.position = "top", title.hjust = 0.5),
    color = guide_legend(title.position = "top", title.hjust = 0.5)
  )

#------------------------------------------------------------------------------#
# 5. Combined Maps Layout (Optional)
#------------------------------------------------------------------------------#
# This combines all the previous maps into a single layout for comparison. It
# allows for a comprehensive view of the different factors affecting flood risk
# in Dhaka.

combined_map <- (flood_risk_map + night_light_intensity_map) /
  (flood_extent_comparison_map + water_bodies_and_waterways_map) +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "bottom",
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  ) +
  plot_annotation(
    title = "Flood Risk Analysis in Dhaka, Bangladesh (2022)",
    subtitle = "Examining flood vulnerability, urban development, and hydrological features",
    caption = "Sources: INFORM Risk Index, VIIRS NTL, World Bank, OpenStreetMap | Visualization: Bachir Sabo",
    theme = theme(
      plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 18, hjust = 0.5),
      plot.caption = element_text(size = 12, hjust = 1)
    )
  )

# To display or save the combined map, uncomment the following lines:
print(combined_map)
ggsave("reports/plots/dhaka_combined_maps.png", combined_map, width = 20, height = 15, dpi = 300)

```


```{r}

#------------------------------------------------------------------------------#
# Define variables and prepare data
#------------------------------------------------------------------------------#

# Variables to plot
variables_to_plot <- c("rain_sum", "precipitation_sum", "river_discharge", 
                       "temperature_2m_mean", "soil_moisture_0_to_10cm_mean", 
                       "pressure_msl_mean")

# Reshape data to long format
climate_long <- climate_spatial_data %>%
  st_drop_geometry() %>%
  select(ADM3_EN, year, all_of(variables_to_plot)) %>%
  pivot_longer(
    cols = all_of(variables_to_plot),
    names_to = "variable",
    values_to = "value"
  ) %>%
  left_join(select(climate_spatial_data, ADM3_EN, year, geometry), by = c("ADM3_EN", "year")) %>%
  st_as_sf()

# Ensure year is numeric
climate_long$year <- as.numeric(as.character(climate_long$year))

# Variable labels
variable_labels <- c(
  rain_sum = "Rain Sum (mm)",
  precipitation_sum = "Precipitation Sum (mm)",
  river_discharge = "River Discharge (m³/s)",
  temperature_2m_mean = "Mean Temperature (°C)",
  soil_moisture_0_to_10cm_mean = "Soil Moisture (0-10 cm) (m³/m³)",
  pressure_msl_mean = "Mean Sea Level Pressure (hPa)"
)

# Define a custom theme for the plot
climate_map_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(size = 10, hjust = 1, margin = margin(t = 10))
  )

# Ensure the required data is loaded:
# NL_data_spatial, climate_spatial_data

#------------------------------------------------------------------------------#
# Animated Map Plot 1: Night Light Intensity Animation
#------------------------------------------------------------------------------#
# Apply log transformation to Night Light data
NL_data_spatial$VIIRS_NTL_log <- log(NL_data_spatial$VIIRS_NTL + 1)

night_light_intensity_animation <- ggplot(NL_data_spatial) +
  geom_sf(aes(fill = VIIRS_NTL_log), color = NA) +
  scale_fill_viridis_c(
    option = "magma",
    name = "Night Light Intensity\n(Log Scaled)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "cm"),
      barheight = unit(0.5, "cm")
    )
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "Night Light Intensity in Dhaka: {frame_time}",
    subtitle = "Night Light Intensity as a Proxy for Economic Activity",
    caption = "Source: VIIRS Nighttime Lights Data | Visualization: Bachir Sabo"
  ) +
  coord_sf(datum = NA) +
  transition_time(year) +
  ease_aes('linear')

# Render and save the animation
animate(
  night_light_intensity_animation,
  nframes = length(unique(NL_data_spatial$year)) * 10,
  fps = 10,
  width = 800,
  height = 600,
  renderer = gifski_renderer("reports/plots/dhaka_nightlight_animation.gif")
)

#------------------------------------------------------------------------------#
# Animated Map Plot 2: Climate Variables Animation
#------------------------------------------------------------------------------#
# Variables to visualize
variables_to_plot <- c("rain_sum", "precipitation_sum", "river_discharge", "temperature_2m_mean","soil_moisture_0_to_10cm_mean","pressure_msl_mean")

# Reshape data to long format
climate_long <- climate_spatial_data %>%
  st_drop_geometry() %>%
  select(ADM3_EN, year, all_of(variables_to_plot)) %>%
  pivot_longer(
    cols = all_of(variables_to_plot),
    names_to = "variable",
    values_to = "value"
  ) %>%
  left_join(select(climate_spatial_data, ADM3_EN, year, geometry), by = c("ADM3_EN", "year")) %>%
  st_as_sf()

# Variable labels
variable_labels <- c(
  rain_sum = "Rain Sum (mm)",
  precipitation_sum = "Precipitation Sum (mm)",
  river_discharge = "River Discharge (m³/s)",
  temperature_2m_mean = "Mean Temperature (°C)",
  soil_moisture_0_to_10cm_mean = "Soil Moisture (0-10 cm) (m³/(m³)",
  pressure_msl_mean = "Mean Sea Level Pressure (hPa)"
)

climate_variables_animation <- ggplot(climate_long) +
  geom_sf(aes(fill = value), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "") +
  facet_wrap(~ variable, ncol = 2, scales = "free", labeller = as_labeller(variable_labels)) +
  labs(
    title = "Yearly Evolution of Climate Variables in Dhaka",
    subtitle = 'Year: {frame_time}',
    caption = "Sources: CEMS GloFAS, Copernicus Climate Data Store | Visualization: Bachir Sabo"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 16),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(size = 12, hjust = 1, margin = margin(t = 10))
  ) +
  transition_time(year) +
  ease_aes('linear')

# Render and save the animation
animate(
  climate_variables_animation,
  nframes = length(unique(climate_long$year)) * 10,
  fps = 10,
  width = 800,
  height = 800,
  renderer = gifski_renderer("reports/plots/dhaka_climate_animation.gif")
)

#------------------------------------------------------------------------------#
# Animated Map Plot 3: River Discharge Animation
#------------------------------------------------------------------------------#
river_discharge_animation <- ggplot(climate_spatial_data) +
  geom_sf(aes(fill = river_discharge), color = NA) +
  scale_fill_viridis_c(
    option = "plasma",
    name = "River Discharge (m³/s)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "cm"),
      barheight = unit(0.5, "cm")
    )
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "River Discharge in Dhaka: {frame_time}",
    caption = "Source: CEMS GloFAS Historical Dataset | Visualization: Bachir Sabo"
  ) +
  coord_sf(datum = NA) +
  transition_time(year) +
  ease_aes('linear')

# Render and save the animation
animate(
  river_discharge_animation,
  nframes = length(unique(climate_spatial_data$year)) * 10,
  fps = 10,
  width = 800,
  height = 600,
  renderer = gifski_renderer("reports/plots/dhaka_river_discharge_animation.gif")
)

```


```{r}
#Simpler plot
ggplot() +
  # Flood risk layer
  geom_sf(data = shapefile_Dhaka_hazard_exposure, aes(fill = flood_risk),
          color = "white", linewidth = 0.0001, alpha = 0.7) +  # Move alpha here
  scale_fill_gradientn(colors = c("#FFFFD9", "#FED98E", "#FE9929", "#D95F0E", "#993404"),
                       breaks = c(0.0, 2.5, 5.0, 7.5),
                       labels = c("0.0", "2.5", "5.0", "7.5"),
                       name = "Flood Risk",
                       guide = guide_colorbar(order = 1)) +
  
  # New fill scale for water bodies
  new_scale_fill() +
  
  # Water bodies layer
  geom_sf(data = water_Dhaka, aes(fill = fclass), color = NA, alpha = 0.4) +
  scale_fill_manual(values = c("water" = "#87CEFA",
                               "dock" = "#20B2AA",
                               "Other" = "#B0E0E6"),
                    name = "Water Bodies",
                    guide = guide_legend(order = 2)) +
  
  # Waterways layer (only rivers and canals)
  geom_sf(data = filter(water_way_Dhaka, fclass %in% c("river", "canal")), 
          aes(color = fclass), linewidth = 0.7) +
  scale_color_manual(values = c("river" = "#0077BE", 
                                "canal" = "#40E0D0"),
                     name = "Waterways",
                     guide = guide_legend(order = 3)) +
  
  # Rest of your code (annotations, labels, theme, etc.)
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  labs(title = "High Flood Risk Dominates Dhaka's Periphery, \n Central Areas Show Lower Vulnerability",
       subtitle = "Flood risk assessment with water bodies and hydrological networks in Dhaka, Bangladesh (2022)",
       caption = "Source: INFORM Sub-national Risk Index & OpenStreetMap 2022 | Created by: Bachir Sabo") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5, margin = margin(b = 20)),
    plot.caption = element_text(size = 10, hjust = 1, margin = margin(t = 20)),
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(t = 10, b = 10, l = 10, r = 10),
    panel.grid.major = element_line(color = "gray90", linewidth = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  ) +
  coord_sf(datum = NA)

```





```{r}
flood_events$year <- as.integer(flood_events$year)

yearly_avg_data_filtered <- yearly_avg_data %>%
  filter(!is.na(norm_nightlight))

# Load the flood icon
normalized_trends_flood_events_plot <- ggplot() +
  geom_line(data = yearly_avg_data, aes(x = year, y = norm_discharge, color = "River Discharge"), size = 1.2) +
  geom_point(data = yearly_avg_data, aes(x = year, y = norm_discharge, color = "River Discharge"), size = 4) +
  geom_line(data = yearly_avg_data, aes(x = year, y = norm_precipitation, color = "Precipitation"), size = 1.2) +
  geom_point(data = yearly_avg_data, aes(x = year, y = norm_precipitation, color = "Precipitation"), size = 4) +
  geom_line(data = yearly_avg_data_filtered, aes(x = year, y = norm_nightlight, color = "Night Light"), size = 1.2) +
  geom_point(data = yearly_avg_data_filtered, aes(x = year, y = norm_nightlight, color = "Night Light"), size = 4) +
  scale_y_continuous(
    name = "Normalized Value",
    labels = scales::number_format(accuracy = 0.01),
    limits = c(0, 1.1)
  ) +
  scale_x_continuous(breaks = 2010:2024) +
  scale_color_manual(values = c("River Discharge" = "blue", "Precipitation" = "darkgreen", "Night Light" = "orange")) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 24, face = "bold"),
    plot.subtitle = element_text(size = 20, face = "italic"),
    axis.title = element_text(size = 18, face = "bold"),
    axis.text = element_text(size = 16),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 16),
    legend.key.size = unit(1.5, "cm"),
    plot.caption = element_text(size = 14, hjust = 1, margin = margin(t = 20))
  ) +
  labs(
    title = "Normalized Trends in Dhaka (2010-2024)",
    subtitle = "River Discharge, Precipitation, Night Light Intensity",
    x = "Year",
    y = "Normalized Value (0-1 scale)",
    caption = "Data Sources: CEMS-GloFAS historical dataset & VIIRS Nighttime Lights | Visualization: Bachir Sabo"
  )

# Add animation-specific layers
normalized_trends_flood_events_plot <- normalized_trends_flood_events_plot +
  transition_reveal(year) +
  ease_aes('linear') +
  enter_fade() +
  exit_fade()

# Define the path for saving the animation
normalized_trends_flood_events_output <- "reports/plots/dhaka_normalized_trends_2010_2024.gif"

# Render and save the animation
animate(normalized_trends_flood_events_plot, 
        nframes = 150, 
        fps = 10, 
        width = 1000, 
        height = 800, 
        renderer = gifski_renderer(normalized_trends_flood_events_output))

```

```{r}



create_animation_plot <- function(data, variable, title, fill_label) {
  ggplot(data) +
    geom_sf(aes_string(fill = variable), color = NA) +
    scale_fill_viridis_c(option = "plasma", name = fill_label) +
    labs(title = title,
         subtitle = 'Year: {frame_time}',
         caption = "Data Source:CEMS GloFAS Historical Dataset, Copernicus Climate Data Store (CDS) & OpenStreetMap | Visualization: Bachir Sabo") +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8),
      plot.caption = element_text(size = 8),
      axis.text = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank()
    ) +
    transition_time(year) +
    ease_aes('linear')
}

# Rain Sum Animation
rain_animation <- create_animation_plot(
  data = climate_spatial_data,
  variable = "rain_sum",
  title = "Yearly Evolution of Rain Sum in Dhaka",
  fill_label = "Rain Sum (mm)"
)

# Precipitation Sum Animation
precipitation_animation <- create_animation_plot(
  data = climate_spatial_data,
  variable = "precipitation_sum",
  title = "Yearly Evolution of Precipitation Sum in Dhaka",
  fill_label = "Precipitation Sum (mm)"
)

# River Discharge Animation
river_discharge_animation <- create_animation_plot(
  data = climate_spatial_data,
  variable = "river_discharge",
  title = "Yearly Evolution of River Discharge in Dhaka",
  fill_label = "River Discharge (m³/s)"
)

# Temperature Animation
temperature_animation <- create_animation_plot(
  data = climate_spatial_data,
  variable = "temperature_2m_mean",
  title = "Yearly Evolution of Mean Temperature in Dhaka",
  fill_label = "Temperature (°C)"
)

# Combine the plots
combined_animation <- (rain_animation | precipitation_animation) /
                      (river_discharge_animation | temperature_animation)

animation <- animate(combined_animation, nframes = 100, fps = 10, width = 800, height = 800)

# Save the animation
anim_save("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/reports/dhaka_climate_animation.gif", animation = animation)

```



```{r}
library(animation)
library(gifski)
# Join NL_data with shapefile_Dhaka_boundari
nl_spatial_data <- shapefile_Dhaka_boundari %>%
  left_join(NL_data, by = "ADM3_EN")

# Create the animated plot
animated_plot <- ggplot(nl_spatial_data) +
  geom_sf(aes(fill = VIIRS_NTL), color = "grey80", size = 0.001) +
  scale_fill_gradient(low = "#000033", high = "#00FFFF", name = "Night Light") +
  labs(
    title = "Yearly Evolution of Night Light in Dhaka",
    subtitle = 'Year: {frame_time}',
    caption = "Data Source: Earth Observation Group - VIIRS Nighttime Lights & OpenStreetMap | Visualization: Bachir Sabo"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, color = "white"),
    plot.subtitle = element_text(size = 14, hjust = 0.5, color = "white"),
    plot.caption = element_text(size = 10, color = "white"),
    legend.position = "right",
    legend.title = element_text(size = 12, color = "white"),
    legend.text = element_text(size = 10, color = "white"),
    panel.background = element_rect(fill = "#000022"),
    plot.background = element_rect(fill = "#000022")
  ) +
  transition_time(year) +
  ease_aes('linear')

# Render the animation
animation <- animate(animated_plot, nframes = 100, fps = 10, width = 800, height = 600)


anim_save("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/reports/dhaka_nightlight_animation.gif", animation = animation)

# Set the output file path
output_file <- "C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/reports/dhaka_nightlight_animation.gif"

# Render and save the animation
animate(
  animated_plot,
  nframes = 100,
  fps = 10,
  width = 800,
  height = 600,
  renderer = gifski_renderer(output_file)
)

```


```{r}
# Your R code here

# Define a custom theme for all maps
map_theme <- theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    legend.spacing.y = unit(0.5, "cm"),
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10)
  )

# Map 1: Flood risk map
map1 <- ggplot() +
  geom_sf(data = shapefile_Dhaka_hazard_exposure, aes(fill = flood_risk), color = NA) +
  scale_fill_gradientn(colors = c("#FFFFD9", "#FED98E", "#FE9929", "#D95F0E", "#993404"),
                       breaks = c(0.0, 2.5, 5.0, 7.5),
                       labels = c("0.0", "2.5", "5.0", "7.5"),
                       name = "Flood Risk") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "Flood Risk in Dhaka, Bangladesh (2022)")+
  coord_sf(datum = NA) +  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Increased title size
    legend.key.size = unit(1.2, "cm"),  # Increase legend key size further
    legend.text = element_text(size = 12),  # Increase legend text size further
    legend.title = element_text(size = 20, face = "bold"),  # Increase legend title size further
    legend.spacing.y = unit(0.7, "cm"),  # Add more vertical space between legend items
    legend.box = "vertical",  # Stack legends vertically
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),  # Add margin around the entire legend
    legend.box.margin = margin(t = 10, r = 10, b = 10, l = 10)  # Add margin around the legend box
  ) +
    guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = 10, barheight = 0.5))

# Map 2: Night Light Intensity map
map2 <- ggplot() +
  geom_sf(data = shapefile_Dhaka_boundari %>% 
            left_join(NL_data %>% filter(year == 2022), by = "ADM3_EN"), 
          aes(fill = VIIRS_NTL), color = NA) +
  scale_fill_gradient(low = "black", high = "yellow", name = "VIIRS Nighttime Lights (Radiance)",
                      guide = guide_colorbar(
                        title.position = "top",
                        title.hjust = 0.5,
                        barwidth = 10,
                        barheight = 0.5
                      )) +
  annotation_scale(location = "bl", width_hint = 0.3, color = "black") +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering(fill = "black", line_col = "black")) +
  map_theme +
  labs(title = "Night Light Intensity in Dhaka (2022)") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5, color = "black"),
    legend.key.size = unit(1.2, "cm"),  # Increase legend key size further
    legend.text = element_text(size = 12),  # Increase legend text size further
    legend.title = element_text(size = 20, face = "bold"),  # Increase legend title size further
    legend.spacing.y = unit(0.7, "cm"),  # Add more vertical space between legend items
    legend.box = "vertical",  # Stack legends vertically
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),  # Add margin around the entire legend
    legend.box.margin = margin(t = 10, r = 10, b = 10, l = 10)  # Add margin around the legend box
  ) + 
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = 10, barheight = 0.5))








# First, ensure we have the log transformation function


# Apply the log transformation to the VIIRS_NTL data
NL_data_spatial$VIIRS_NTL_log <- log_scale(NL_data_spatial$VIIRS_NTL)
NL_data_spatial$VIIRS_NTL_cbrt <- sign(NL_data_spatial$VIIRS_NTL) * abs(NL_data_spatial$VIIRS_NTL)^(1/3)



#     scale_fill_gradient(low = "black", high = "yellow", 
#                         name = "VIIRS Nighttime Lights",
#                         guide = guide_colorbar(title.position = "top", 
#                                                title.hjust = 0.5,
#                                                barwidth = 10, 
#                                                barheight = 0.5)) +


nightlight_animation <- ggplot() +
  geom_sf(data = NL_data_spatial, aes(fill = VIIRS_NTL_log), color = NA) +
  scale_fill_gradientn(
    colors = c("black", "yellow"),  # Corrected this line
    name = "Night Light Intensity\n(Scaled Log Transformed)",
    guide = guide_colorbar(title.position = "top", 
                           title.hjust = 0.5,
                           barwidth = 10, 
                           barheight = 0.5)
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "Night Light Intensity in Dhaka: {as.integer(frame_time)}",
       caption = "Source: VIIRS Nighttime Light Data | Visualization: Bachir Sabo") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    legend.spacing.y = unit(0.5, "cm"),
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.caption = element_text(size = 10, hjust = 1, margin = margin(t = 10))
  ) +
  transition_time(year) +
  ease_aes('linear')
# Render the animation
anim <- animate(nightlight_animation, 
                nframes = 120,  # 10 frames per year
                fps = 10, 
                width = 800, 
                height = 600,
                renderer = gifski_renderer("simple_night_light_animation_2.gif"))



# Modified code for the animated Night Light Intensity map
nightlight_animation <- ggplot() +
  geom_sf(data = NL_data_spatial, aes(fill = VIIRS_NTL_log), color = NA) +
  # Use a better color palette for Night Light Intensity
  scale_fill_viridis_c(
    option = "magma",
    name = "Night Light Intensity\n(Log Scaled)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "cm"),
      barheight = unit(0.5, "cm")
    )
  ) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style = north_arrow_fancy_orienteering
  ) +
  map_theme +
  labs(
    title = "Night Light Intensity in Dhaka: {as.integer(frame_time)}",
    subtitle = "Night Light Intensity as a Proxy for Economic Activity",
    caption = "Source: VIIRS Nighttime Light Data | Visualization: Your Name"
  ) +
  coord_sf(
    xlim = c(map_extent$xmin, map_extent$xmax),
    ylim = c(map_extent$ymin, map_extent$ymax),
    datum = NA
  ) +
  transition_time(year) +
  ease_aes('linear') +
  view_static()  # Keeps the view static throughout the animation

# Render the animation
anim <- animate(
  nightlight_animation,
  nframes = length(unique(NL_data_spatial$year)) * 10,  # 10 frames per year
  fps = 10,
  width = 800,
  height = 600,
  renderer = gifski_renderer("night_light_animation_improved.gif")
)


















map2_animation <- ggplot() +
  geom_sf(data = NL_data_spatial, aes(fill = VIIRS_NTL), color = NA) +
  scale_fill_gradient(low = "black", high = "yellow", name = "VIIRS Nighttime Lights (Radiance)",
                      guide = guide_colorbar(
                        title.position = "top",
                        title.hjust = 0.5,
                        barwidth = 10,
                        barheight = 0.5
                      )) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering(fill = "black", line_col = "black")) +
  map_theme +
  labs(title = "Night Light Intensity in Dhaka: {frame_time}") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5, color = "black"),
    plot.subtitle = element_text(size = 16, hjust = 0.5, color = "red", face = "bold"),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 20, face = "bold"),
    legend.spacing.y = unit(0.7, "cm"),
    legend.box = "vertical",
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.box.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) + 
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = 10, barheight = 0.5)) +
  transition_time(year) +
  ease_aes('linear') +
  labs(subtitle = "Flash floods occurred in 2017") +
  view_follow(fixed_y = TRUE)

night_light_animation <- animate(map2_animation, nframes = 200, fps = 10, width = 800, height = 600,
                                 renderer = gifski_renderer("night_light_animation.gif"))
# Display the animation
night_light_animation


# # Display the animation
# precipitation_animation
# Map 3: Precipitation map for 2022
map3 <- ggplot() +
  geom_sf(data = climate_spatial_data %>% filter(year == 2022), 
          aes(fill = precipitation_sum), color = NA) +
  scale_fill_viridis_c(option = "viridis", name = "Precipitation (mm)") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "Precipitation in Dhaka (2022)") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Increased title size
    legend.key.size = unit(1.2, "cm"),  # Increase legend key size further
    legend.text = element_text(size = 12),  # Increase legend text size further
    legend.title = element_text(size = 20, face = "bold"),  # Increase legend title size further
    legend.spacing.y = unit(0.7, "cm"),  # Add more vertical space between legend items
    legend.box = "vertical",  # Stack legends vertically
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),  # Add margin around the entire legend
    legend.box.margin = margin(t = 10, r = 10, b = 10, l = 10)  # Add margin around the legend box
  ) + 
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, barwidth = 10, barheight = 0.5))


# Map 3: Precipitation animation
map3_animation <- ggplot() +
  geom_sf(data = climate_spatial_data, aes(fill = precipitation_sum), color = NA) +
  scale_fill_viridis_c(option = "viridis", name = "Precipitation (mm)") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "Precipitation in Dhaka: {as.integer(frame_time)}",
      subtitle = "Annual Average River Precipitation",
       caption = "Source: CEMS GloFAS Historical Dataset | Visualization: Bachir Sabo") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    legend.spacing.y = unit(0.5, "cm"),
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) +
  transition_time(year) +
  ease_aes('linear')

# Render the animation
precipitation_animation <- animate(map3_animation, nframes = 200, fps = 10, width = 800, height = 600,
                                   renderer = gifski_renderer("precipitation_animation.gif"))

river_discharge_animation <- ggplot() +
  geom_sf(data = climate_spatial_data, aes(fill = river_discharge), color = NA) +
  scale_fill_viridis_c(option = "viridis", name = "River Discharge (m³/s)") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "River Discharge in Dhaka: {as.integer(frame_time)}",
       subtitle = "Annual Average River Discharge",
       caption = "Source: CEMS GloFAS Historical Dataset | Visualization: Bachir Sabo") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16, face = "italic"),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14, face = "bold"),
    legend.spacing.y = unit(0.5, "cm"),
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.caption = element_text(size = 10, hjust = 1, margin = margin(t = 10))
  ) +
  transition_time(year) +
  ease_aes('linear')

# Render the animation
river_discharge_anim <- animate(river_discharge_animation, 
                                nframes = 200, 
                                fps = 10, 
                                width = 800, 
                                height = 600,
                                renderer = gifski_renderer("river_discharge_animation.gif"))

# Map 4: Water bodies and waterways
map4 <- ggplot() +
  geom_sf(data = water_Dhaka, aes(fill = fclass), color = NA, alpha = 0.8) +
  scale_fill_manual(values = c("water" = "#87CEFA", "dock" = "#20B2AA", "wetland" = "#300101","riverbank"="grey", "Other" = "#B0E0E6"),
                    name = "Water Bodies") +
  geom_sf(data = filter(water_way_Dhaka, fclass %in% c("river", "canal", "stream", "drain")), 
          aes(color = fclass), linewidth = 0.7) +
  scale_color_manual(values = c("river" = "#1E90FF", "canal" = "#00CED1", "stream" = "#20B2AA",
                                "drain" = "red"),
                     name = "Waterways") +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "tr", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering) +
  map_theme +
  labs(title = "Water Bodies and Waterways in Dhaka") +
  coord_sf(datum = NA) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Increased title size
    legend.key.size = unit(1.2, "cm"),  # Increase legend key size further
    legend.text = element_text(size = 12),  # Increase legend text size further
    legend.title = element_text(size = 20, face = "bold"),  # Increase legend title size further
    legend.spacing.y = unit(0.7, "cm"),  # Add more vertical space between legend items
    legend.box = "vertical",  # Stack legends vertically
    legend.margin = margin(t = 10, r = 10, b = 10, l = 10),  # Add margin around the entire legend
    legend.box.margin = margin(t = 10, r = 10, b = 10, l = 10)  # Add margin around the legend box
  ) +
  guides(
    fill = guide_legend(title = "Water Bodies", order = 1),
    color = guide_legend(title = "Waterways", order = 2)
  ) + 
  guides(
    fill = guide_legend(title = "Water Bodies", order = 1, title.position = "top", title.hjust = 0.5),
    color = guide_legend(title = "Waterways", order = 2, title.position = "top", title.hjust = 0.5)
  )


# Combine all maps
combined_plot <- (map1 + map2) / (map3 + map4) +
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom",
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20))

# Add overall title and caption
combined_plot <- combined_plot +
  plot_annotation(
    title = "Flood Risk Analysis in Dhaka, Bangladesh (2022)",
    subtitle = "Examining flood vulnerability, precipitation patterns, urban development, and hydrological features",
    caption = "Source: CEMS GloFAS Historical Dataset, Copernicus Climate Data Store (CDS), \n INFORM Sub-national Risk Index & OpenStreetMap 2022 | Vizualisation : Bachir Sabo",
    theme = theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
                  plot.subtitle = element_text(size = 14, hjust = 0.5),
                  plot.caption = element_text(size = 10, hjust = 1))
  )

# Display the combined plot
combined_plot

```



```{r}
# Night Light Intensity map whith different VIIRS transformations
# create_and_save_static_map <- function(data, value_col, title, filename) {
#   map <- ggplot(data) +
#     geom_sf(aes(fill = !!sym(value_col)), color = NA) +
#     scale_fill_gradient(low = "black", high = "yellow", 
#                         name = "VIIRS Nighttime Lights",
#                         guide = guide_colorbar(title.position = "top", 
#                                                title.hjust = 0.5,
#                                                barwidth = 10, 
#                                                barheight = 0.5)) +
#     theme_minimal() +
#     theme(
#       plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
#       plot.subtitle = element_text(size = 12, hjust = 0.5),
#       legend.key.size = unit(1, "cm"),
#       legend.text = element_text(size = 10),
#       legend.title = element_text(size = 12, face = "bold"),
#       legend.position = "bottom"
#     ) +
#     labs(title = title,
#          subtitle = "Dhaka, Bangladesh - 2023",
#          caption = "Data: VIIRS Nighttime Lights | Visualization: Your Name") +
#     coord_sf(datum = NA)
  
#   ggsave(filename, map, width = 10, height = 8, dpi = 300)
#   return(map)
# }

# # Apply transformations
# NL_data_spatial$VIIRS_NTL_sqrt <- sqrt(NL_data_spatial$VIIRS_NTL)
# NL_data_spatial$VIIRS_NTL_cbrt <- sign(NL_data_spatial$VIIRS_NTL) * abs(NL_data_spatial$VIIRS_NTL)^(1/3)
# NL_data_spatial$VIIRS_NTL_asinh <- asinh(NL_data_spatial$VIIRS_NTL)
# NL_data_spatial$VIIRS_NTL_power <- sign(NL_data_spatial$VIIRS_NTL) * abs(NL_data_spatial$VIIRS_NTL)^0.5

# log_scale <- function(x) {
#   scaled <- (log(x + 1) - log(min(x) + 1)) / (log(max(x) + 1) - log(min(x) + 1))
#   scaled * (max(x) - min(x)) + min(x)
# }
# NL_data_spatial$VIIRS_NTL_log_scale <- log_scale(NL_data_spatial$VIIRS_NTL)

# # Create maps
# # Create and save maps
# map_original <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL", "Original VIIRS Nighttime Lights", "nightlight_original.png")
# map_sqrt <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL_sqrt", "Square Root Transformed VIIRS Nighttime Lights", "nightlight_sqrt.png")
# map_cbrt <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL_cbrt", "Cube Root Transformed VIIRS Nighttime Lights", "nightlight_cbrt.png")
# map_asinh <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL_asinh", "Asinh Transformed VIIRS Nighttime Lights", "nightlight_asinh.png")
# map_power <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL_power", "Power (0.5) Transformed VIIRS Nighttime Lights", "nightlight_power.png")
# map_log_scale <- create_and_save_static_map(NL_data_spatial, "VIIRS_NTL_log_scale", "Scaled Log Transformed VIIRS Nighttime Lights", "nightlight_log_scale.png")

# # Display each map (optional)
# print(map_original)
# print(map_sqrt)
# print(map_cbrt)
# print(map_asinh)
# print(map_power)
# print(map_log_scale)

```




```{r}


```



```{r}

```




```{r}
# Animated plot

# Variables to visualize
variables_to_plot <- c("rain_sum", "precipitation_sum", "river_discharge", "temperature_2m_mean")

# Separate geometry from non-geometry data
non_geometry_data <- climate_spatial_data %>%
  st_drop_geometry() %>%  # Drop geometry to simplify data
  select(ADM3_EN, year, all_of(variables_to_plot))

geometry_data <- climate_spatial_data %>%
  select(ADM3_EN, year, geometry)

# Reshape data
climate_long <- non_geometry_data %>%
  pivot_longer(
    cols = all_of(variables_to_plot),
    names_to = "variable",
    values_to = "value"
  )

# First join (optional, can be skipped if not needed)
# climate_long <- climate_long %>%
#   left_join(geometry_data, by = c("ADM3_EN", "year"))

# Aggregate geometry to ensure uniqueness
geometry_data <- geometry_data %>%
  group_by(ADM3_EN, year) %>%
  summarize(geometry = st_union(geometry), .groups = 'drop')

# Simplify geometries during aggregation
geometry_data_simplified <- geometry_data %>%
  group_by(ADM3_EN, year) %>%
  summarize(geometry = st_union(geometry), .groups = 'drop') %>%
  ms_simplify(keep = 0.05, keep_shapes = TRUE)



# Join simplified geometries
climate_long <- climate_long %>%
  left_join(geometry_data_simplified, by = c("ADM3_EN", "year"))

# Remove any duplicate geometry columns
climate_long <- climate_long %>%
  select(-geometry.x) %>%
  rename(geometry = geometry.y)

# Convert to sf object
climate_long_sf <- st_as_sf(climate_long)

# Variable labels
variable_labels <- c(
  rain_sum = "Rain Sum (mm)",
  precipitation_sum = "Precipitation Sum (mm)",
  river_discharge = "River Discharge (m³/s)",
  temperature_2m_mean = "Mean Temperature (°C)"
)

# Create the animated plot
animated_plot <- ggplot(climate_long_sf) +
  geom_sf(aes(fill = value), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "", na.value = "grey50") +
  facet_wrap(~ variable, ncol = 2, scales = "free", labeller = as_labeller(variable_labels)) +
  labs(
    title = "Yearly Evolution of Climate Variables in Dhaka",
    subtitle = 'Year: {frame_time}',
    caption = "Data Source: CEMS GloFAS Historical Dataset, Copernicus Climate Data Store (CDS) & OpenStreetMap | Visualization: Bachir Sabo"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  transition_time(year) +
  ease_aes('linear')

# Render the animation
animation <- animate(animated_plot, nframes = 100, fps = 10, width = 800, height = 800)

# Save the animation
anim_save("C:/Users/bachi/Documents/GIT_PROJECTS/Assessing-Urban-Flood-Risk-in-Dhaka-Bangladesh/reports/dhaka_climate_animation.gif", animation = animation)



```
